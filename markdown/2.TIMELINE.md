# API Gateway Development Process - Step by Step

---

## Table of Contents

- [Phase 1: Routing & Configuration](#phase-1-routing--configuration) âœ… DONE
  - [1. Configuration Management](#1-configuration-management)
  - [2. Route Registration](#2-route-registration)
  - [3. Path Matching (PathTrie)](#3-path-matching-pathtrie)
  - [4. Error Handling](#4-error-handling)
  - [5. CORS Configuration](#5-cors-configuration-cross-origin-resource-sharing) 
- [Phase 2: Filter Implementation](#phase-2-filter-implementation)
  - [Filter Chain Overview](#filter-chain-overview)
  - [Filter 1: Validation Filter (Order: -20)](#filter-1-validation-filter-order--20) âœ… DONE
  - [Filter 2: Authentication Filter (Order: 0)](#filter-2-authentication-filter-order-0) âœ… DONE
  - [Filter 3: Authorization Filter (Order: 1)](#filter-3-authorization-filter-order-1) 
  - [Filter 4: Rate Limiting Filter](#filter-4-rate-limiting-filter-dual-implementation) 
- [Phase 3: Monitoring & Observability](#phase-3-monitoring--observability) 
  - [1. Metrics (Micrometer + Prometheus)](#-1-metrics-micrometer--prometheus)
  - [2. Logging (Structured Logging)](#-2-logging-structured-logging-with-logback)
  - [3. Distributed Tracing](#-3-distributed-tracing-spring-cloud-sleuth--zipkin)
---

## PHASE 1: ROUTING & CONFIGURATION

### 1. Configuration Management

**Thá»© Tá»± Implementation:**
```
1. Táº¡o configuration trong application.yml â†’ "app"
2. Táº¡o Config classes Ä‘á»ƒ Ä‘á»c properties tá»« YAML
3. Implement Repository Ä‘á»ƒ load vÃ  quáº£n lÃ½ config
```

**Kiáº¿n TrÃºc File Structure:**

```
ğŸ“ Cáº¥u trÃºc file Ä‘á»ƒ quáº£n lÃ½ configuration nhÆ° database:
    1ï¸âƒ£ Entity Layer (/entity): Äá»‹nh nghÄ©a data model (object structure)
    2ï¸âƒ£ Config Layer (/data/config): Load data tá»« application.yml
    3ï¸âƒ£ Repository Interface (/interfaces)
    â””â”€ Äá»‹nh nghÄ©a contract cho data access
    â””â”€ Má»¥c Ä‘Ã­ch: Dá»… dÃ ng chuyá»ƒn Ä‘á»•i tá»« file config â†’ database
    4ï¸âƒ£ Repository Implementation (/repository): Implement interface vá»›i concrete logic
    5ï¸âƒ£ Service Layer (/service)
    â””â”€ Business logic vÃ  data manipulation
    â””â”€ Query, filter, transform data
```

**Benefits cá»§a kiáº¿n trÃºc nÃ y:**
- Dá»… dÃ ng chuyá»ƒn Ä‘á»•i tá»« YAML config â†’ Database
- Code khÃ´ng cáº§n thay Ä‘á»•i khi Ä‘á»•i data source
- TuÃ¢n thá»§ SOLID principles (Dependency Inversion)

---

### 2. Route Registration

**Startup Flow:**
```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ 1. Application Startup                              â”‚
                        â”‚    â””â”€ Spring Boot initializes beans                 â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ 2. GatewayStartupLoader (@PostConstruct)            â”‚
                        â”‚    â””â”€ Load data from YAML/database                  â”‚
                        â”‚    â””â”€ Initialize all services (routes, endpoints,   â”‚
                        â”‚       headers, roles, method rules)                 â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ 3. Load Services Configuration                      â”‚
                        â”‚    â””â”€ RouteRegistryService.loadAll()                â”‚
                        â”‚    â””â”€ ...                                           â”‚  
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ 4. Register Routes Dynamically (GatewayConfig)      â”‚
                        â”‚    â””â”€ RouteDefinitionLocator for each service       â”‚
                        â”‚    â””â”€ Apply filters: Authentication, StripPrefix,...â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ 5. Gateway Ready                                    â”‚
                        â”‚    â””â”€ Accept incoming requests                      â”‚
                        â”‚    â””â”€ Route to appropriate services                 â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Path Matching (PathTrie)

**Má»¥c Ä‘Ã­ch:**
```
Sá»­ dá»¥ng cáº¥u trÃºc dá»¯ liá»‡u Trie Ä‘á»ƒ match request path vá»›i endpoint
Ä‘Ã£ Ä‘Äƒng kÃ½. Há»— trá»£ path parameters (vÃ­ dá»¥: /users/{userId}).
```

**CÃ¡ch hoáº¡t Ä‘á»™ng:**
```
Registered Endpoints:
  /users              â†’ GET
  /users/{userId}     â†’ GET, PUT, DELETE
  /users/{userId}/orders â†’ GET

Trie Structure:
  root
   â””â”€ users
       â”œâ”€ [GET] â† match "/users"
       â””â”€ {userId}  (wildcard node)
           â”œâ”€ [GET, PUT, DELETE] â† match "/users/123"
           â””â”€ orders
               â””â”€ [GET] â† match "/users/123/orders"
```

**Match Results:**
```
Request: GET /users/123
  â†’ MatchResult: FOUND (matched /users/{userId})

Request: POST /users/123
  â†’ MatchResult: METHOD_NOT_ALLOWED (path exists, method khÃ´ng Ä‘Ãºng)

Request: GET /products/123
  â†’ MatchResult: NOT_FOUND (path khÃ´ng tá»“n táº¡i)
```

---

### 4. Error Handling

**Kiáº¿n TrÃºc File Structure:**
```
ğŸ“ Error handling gá»“m 2 thÃ nh pháº§n:
1ï¸âƒ£ DTO Layer (/dto)
   â””â”€ ErrorResponse.java         â†’ Data model cho error JSON body
2ï¸âƒ£ Utility Layer (/util)
   â””â”€ ErrorHandler.java          â†’ Shared component, dÃ¹ng chung cho táº¥t cáº£ filters
```

**ErrorResponse DTO:**
```
    ErrorResponse (com.cathay.apigateway.dto)
    â”œâ”€â”€ status: int               â†’ HTTP status code (400, 401, 403, 404...)
    â”œâ”€â”€ error: String             â†’ HTTP reason phrase ("Forbidden", "Not Found"...)
    â”œâ”€â”€ message: String           â†’ Chi tiáº¿t lá»—i (5xx â†’ "Internal Server Error")
    â”œâ”€â”€ path: String              â†’ Request path gÃ¢y lá»—i
    â””â”€â”€ timestamp: LocalDateTime  â†’ Thá»i Ä‘iá»ƒm xáº£y ra lá»—i (auto = now())
```

**Sá»­ Dá»¥ng Trong CÃ¡c Filters:**
```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Filter                   â”‚ Status â”‚ Error Cases                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Validation Filter (-20)  â”‚  404   â”‚ Endpoint not found               â”‚
    â”‚                          â”‚  404   â”‚ Endpoint is not available        â”‚
    â”‚                          â”‚  400   â”‚ Too many query parameters        â”‚
    â”‚                          â”‚  401   â”‚ Missing required header          â”‚
    â”‚                          â”‚  400   â”‚ Body required with Content-Lengthâ”‚
    â”‚                          â”‚  413   â”‚ Payload too large                â”‚
    â”‚                          â”‚  415   â”‚ Unsupported Content-Type         â”‚
    â”‚                          â”‚  400   â”‚ CRLF injection in header         â”‚
    â”‚                          â”‚  400   â”‚ Header exceeds max length        â”‚
    â”‚                          â”‚  400   â”‚ Header invalid format (regex)    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Authentication Filter (0)â”‚  401   â”‚ Missing Authorization header     â”‚
    â”‚                          â”‚  401   â”‚ Invalid Bearer format            â”‚
    â”‚                          â”‚  401   â”‚ JWT validation failed            â”‚
    â”‚                          â”‚  401   â”‚ Access token has expired         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Authorization Filter (1) â”‚  404   â”‚ Endpoint not found               â”‚
    â”‚  ğŸ”² PLANNED              â”‚  403   â”‚ Missing X-User-Role header       â”‚
    â”‚                          â”‚  403   â”‚ Insufficient role level          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Example Error Response:**
```json
{
    "status": 403,
    "error": "Forbidden",
    "message": "Access denied: insufficient role level",
    "path": "/api/v1/identify-service/users",
    "timestamp": "2026-02-09T12:00:00"
}
```

---

### 5. CORS Configuration (Cross Origin Resource Sharing)

**CORS lÃ  gÃ¬?**

Browser máº·c Ä‘á»‹nh Ã¡p dá»¥ng **Same-Origin Policy** â€” chá»‰ cho phÃ©p JavaScript gá»i API
cÃ¹ng origin (protocol + domain + port). Khi Frontend (React/Vue cháº¡y trÃªn `http://localhost:3000`) gá»i API Gateway (`http://localhost:8080`), browser sáº½ **block** response vÃ¬ khÃ¡c origin.

CORS lÃ  cÆ¡ cháº¿ cho phÃ©p server **khai bÃ¡o** nhá»¯ng origin nÃ o Ä‘Æ°á»£c phÃ©p truy cáº­p tÃ i nguyÃªn.

> **Táº¡i sao dÃ¹ng Config thay vÃ¬ Custom Filter?**
> Spring Cloud Gateway Ä‘Ã£ cÃ³ sáºµn `CorsWebFilter` xá»­ lÃ½ Ä‘Ãºng CORS spec (preflight, `Vary` header,
> credentials mode, edge cases). Viáº¿t custom filter lÃ  reinvent the wheel vÃ  dá»… thiáº¿u edge case.
> Ta chá»‰ cáº§n táº¡o `@Configuration` bean Ä‘á»ƒ khai bÃ¡o CORS policy, Spring lo pháº§n cÃ²n láº¡i.

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
ğŸ”² Khai bÃ¡o allowed origins trong application.yml (linh hoáº¡t giá»¯a dev/staging/prod)
ğŸ”² Táº¡o CorsPropertiesConfig (@ConfigurationProperties) bind tá»« yml
ğŸ”² Táº¡o CorsConfig (@Configuration) register CorsWebFilter bean
ğŸ”² Spring tá»± xá»­ lÃ½: preflight OPTIONS, validate origin, set CORS response headers
```

**ğŸ“ Cáº¥u trÃºc files:**
```
application.yml                          â† Khai bÃ¡o CORS properties
  â””â”€ app.cors.allowed-origins, allowed-methods, ...

CorsPropertiesConfig.java               â† @ConfigurationProperties bind yml â†’ Java object
  â””â”€ data/config/CorsPropertiesConfig.java

CorsConfig.java                          â† @Configuration táº¡o CorsWebFilter bean
  â””â”€ config/CorsConfig.java
```

**ğŸ”„ CORS Flow (Spring xá»­ lÃ½ tá»± Ä‘á»™ng):**

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Browser gá»­i request cross-origin                                  â”‚
    â”‚  Origin: http://localhost:3000                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. Simple Request hay Preflight?                                  â”‚
    â”‚     â€¢ Simple: GET/POST vá»›i Content-Type Ä‘Æ¡n giáº£n, no custom headersâ”‚
    â”‚     â€¢ Preflight: PUT/DELETE/PATCH, hoáº·c cÃ³ custom headers          â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Simple Request                        â”‚ Preflight Required
           â”‚                                       â”‚
           â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                        â”‚  2. Browser tá»± gá»­i OPTIONS        â”‚
           â”‚                        â”‚     Access-Control-Request-Method â”‚
           â”‚                        â”‚     Access-Control-Request-Headersâ”‚
           â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  3. CorsWebFilter (Spring built-in) kiá»ƒm tra Origin               â”‚
    â”‚     â€¢ Origin cÃ³ trong allowed-origins whitelist?                  â”‚
    â”‚     â€¢ Tá»± thÃªm Vary: Origin header                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ âœ” Allowed                             â”‚ âœ– Not Allowed
           â”‚                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  4a. Spring tá»± thÃªm headers:    â”‚    â”‚  4b. KhÃ´ng thÃªm headers   â”‚
    â”‚  Access-Control-Allow-Origin    â”‚    â”‚  Browser sáº½ block responseâ”‚
    â”‚  Access-Control-Allow-Methods   â”‚    â”‚  â†’ CORS error trÃªn consoleâ”‚
    â”‚  Access-Control-Allow-Headers   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  Access-Control-Max-Age         â”‚
    â”‚  Access-Control-Expose-Headers  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  5. Preflight? â†’ Return 200 OK  â”‚
    â”‚     (KhÃ´ng qua Authen/Author)   â”‚
    â”‚     Simple?   â†’ Filter Chain    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ CORS Response Headers (Spring tá»± set):**

| Header | GiÃ¡ trá»‹ | Ã nghÄ©a |
|---|---|---|
| `Access-Control-Allow-Origin` | `http://localhost:3000` | Origin Ä‘Æ°á»£c phÃ©p (KHÃ”NG dÃ¹ng `*` náº¿u cÃ³ credentials) |
| `Access-Control-Allow-Methods` | `GET, POST, PUT, DELETE, PATCH, OPTIONS` | HTTP methods Ä‘Æ°á»£c phÃ©p |
| `Access-Control-Allow-Headers` | `Authorization, Content-Type, X-Request-ID, ...` | Request headers Ä‘Æ°á»£c phÃ©p |
| `Access-Control-Allow-Credentials` | `true` | Cho phÃ©p gá»­i cookies/JWT |
| `Access-Control-Max-Age` | `3600` | Cache preflight response 1 giá» (giáº£m OPTIONS requests) |
| `Access-Control-Expose-Headers` | `X-Request-ID, X-RateLimit-Remaining` | Response headers mÃ  JS Ä‘Æ°á»£c phÃ©p Ä‘á»c |
| `Vary` | `Origin` | Spring tá»± thÃªm â€” giÃºp CDN/proxy cache Ä‘Ãºng theo origin |

**âš ï¸ LÆ°u Ã½ quan trá»ng:**
```
1. Access-Control-Allow-Origin KHÃ”NG Ä‘Æ°á»£c dÃ¹ng wildcard (*) khi Allow-Credentials = true
   â†’ Pháº£i tráº£ exact origin: "http://localhost:3000"
   â†’ Spring CorsWebFilter xá»­ lÃ½ Ä‘Ãºng Ä‘iá»u nÃ y tá»± Ä‘á»™ng

2. Preflight (OPTIONS) request Ä‘Æ°á»£c Spring tráº£ response NGAY
   â†’ KhÃ´ng Ä‘i qua Authentication/Authorization (vÃ¬ OPTIONS khÃ´ng mang JWT)
   â†’ CorsWebFilter cháº¡y trÆ°á»›c filter chain, khÃ´ng cáº§n lo order

3. Allowed origins cáº¥u hÃ¬nh trong application.yml, khÃ´ng hardcode
   â†’ Dá»… thay Ä‘á»•i giá»¯a dev/staging/production environments
   â†’ CÃ³ thá»ƒ dÃ¹ng allowed-origin-patterns cho regex matching (*.example.com)

4. Access-Control-Max-Age giÃºp browser cache preflight response
   â†’ Giáº£m sá»‘ lÆ°á»£ng OPTIONS requests, cáº£i thiá»‡n performance
```

**ğŸ”‘ Implementation (Java Config Bean):**

1ï¸âƒ£ **`application.yml`** â€” khai bÃ¡o CORS properties:
```yaml
app:
  cors:
    allowed-origins:
      - "http://localhost:3000"
      - "http://localhost:5173"
    allowed-methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
    allowed-headers: [Authorization, Content-Type, X-Request-ID]
    expose-headers: [X-Request-ID, X-RateLimit-Remaining]
    allow-credentials: true
    max-age: 3600
```

2ï¸âƒ£ **`CorsPropertiesConfig.java`** â€” bind yml thÃ nh Java object:
```java
@Data
@ConfigurationProperties(prefix = "app.cors")
public class CorsPropertiesConfig {
    private List<String> allowedOrigins = List.of();
    private List<String> allowedMethods = List.of("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS");
    private List<String> allowedHeaders = List.of("Authorization", "Content-Type");
    private List<String> exposeHeaders = List.of();
    private boolean allowCredentials = true;
    private long maxAge = 3600;
}
```

3ï¸âƒ£ **`CorsConfig.java`** â€” táº¡o CorsWebFilter bean:
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsWebFilter corsWebFilter(CorsPropertiesConfig props) {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(props.getAllowedOrigins());
        config.setAllowedMethods(props.getAllowedMethods());
        config.setAllowedHeaders(props.getAllowedHeaders());
        config.setExposedHeaders(props.getExposeHeaders());
        config.setAllowCredentials(props.isAllowCredentials());
        config.setMaxAge(props.getMaxAge());

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return new CorsWebFilter(source);
    }
}
```

**ğŸ’¡ Táº¡i sao khÃ´ng viáº¿t Custom Filter?**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TiÃªu chÃ­        â”‚   Java Config Bean    â”‚    Custom Filter       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ÄÃºng CORS spec          â”‚ Spring lo (Ä‘Ã£ test)   â”‚ Tá»± lo (dá»… thiáº¿u)      â”‚
â”‚ Preflight handling      â”‚ Tá»± Ä‘á»™ng               â”‚ Tá»± viáº¿t                â”‚
â”‚ Vary: Origin            â”‚ Tá»± Ä‘á»™ng               â”‚ Pháº£i nhá»› thÃªm         â”‚
â”‚ Credentials + wildcard  â”‚ Tá»± validate           â”‚ Pháº£i tá»± check         â”‚
â”‚ LÆ°á»£ng code              â”‚ ~20 dÃ²ng              â”‚ ~80-100 dÃ²ng          â”‚
â”‚ Má»Ÿ rá»™ng dynamic origins â”‚ Thay props source     â”‚ Rewrite filter         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ Chá»‰ cáº§n custom filter khi cÃ³ yÃªu cáº§u mÃ  CorsWebFilter khÃ´ng support
  (vÃ­ dá»¥: dynamic origins tá»« DB theo multi-tenant). TrÆ°á»ng há»£p nÃ y ráº¥t hiáº¿m.
```

---

## PHASE 2: FILTER IMPLEMENTATION

### Filter Chain Overview

```
Request Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Request                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Rate Limit (IP-Based) â”‚ Order: -10         
         â”‚ (DDoS protection)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Validation Filter     â”‚ Order: -20         âœ… DONE
         â”‚ (Headers, Body, etc)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Authentication        â”‚ Order: 0           âœ… DONE
         â”‚ (JWT Validation)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Authorization         â”‚ Order: 1           
         â”‚ (Permission Check)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Rate Limit (Account)  â”‚ Order: 10         
         â”‚ (User Quota)          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Backend Service       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Filter 1: Validation Filter (Order: -20)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… Kiá»ƒm tra endpoint cÃ³ tá»“n táº¡i khÃ´ng (path + method) â€” via PathTrie (EndpointRegisterService)
âœ… Validate method requirements (via MethodRuleService):
   â€¢ POST/PUT/PATCH: Require body (check exists + size), Content-Type
   â€¢ GET/DELETE: Validate query params (check exists + size)
âœ… Kiá»ƒm tra required headers cá»§a tá»«ng endpoint (via EndpointHeaderRuleService)
âœ… Validate header values: allowed patterns (regex), max length
âœ… PhÃ²ng chá»‘ng CRLF injection trong header values
âœ… Block requests tá»« blocked domains
```

---

### Filter 2: Authentication Filter (Order: 0)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… PhÃ¢n biá»‡t endpoint: Public vs Protected (isPublic flag)
âœ… Public endpoint:
   â€¢ Skip JWT validation
   â€¢ Add Internal API key vÃ o headers
   â€¢ Forward to next filter
âœ… Protected endpoint:
   â€¢ Validate JWT token (signature, expiration)
   â€¢ Extract user info (userId, email, role)
   â€¢ Add user context vÃ o request headers
   â€¢ Add Internal API key vÃ o headers
   â€¢ Forward to next filter
```

**ğŸ” Authentication Flow:**
```
Request with JWT Token
    â”œâ”€â†’ Check endpoint type (isPublic)
    â”‚   â”œâ”€â†’ Public? â†’ Skip validation â†’ Add API key â†’ Next filter
    â”‚   â””â”€â†’ Protected? â†’ Continue validation
    â”œâ”€â†’ Extract JWT from Authorization header
    â”‚   â””â”€â†’ Format: "Bearer <token>"
    â”œâ”€â†’ Validate JWT (JwtUtil)
    â”‚   â”œâ”€â†’ Verify signature (secret key)
    â”‚   â”œâ”€â†’ Check expiration time
    â”‚   â””â”€â†’ Validate claims
    â”œâ”€â†’ Extract user info from JWT claims
    â”‚   â”œâ”€â†’ userId (subject)
    â”‚   â”œâ”€â†’ email
    â”‚   â””â”€â†’ role
    â””â”€â†’ Add to request headers
        â”œâ”€â†’ X-User-Id: {userId}
        â”œâ”€â†’ X-User-Email: {email}
        â”œâ”€â†’ X-User-Role: {role}
        â””â”€â†’ X-Internal-API-Key: {internalApiKey}

```
---

### Filter 3: Authorization Filter (Order: 1)

> **Note:** Data layer Ä‘Ã£ implement (RoleService vá»›i level-based hierarchy).
> Filter thá»±c táº¿ chÆ°a Ä‘Æ°á»£c táº¡o.

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
- Resolve endpoint: path + method â†’ EndpointsEntity (EndpointRegisterService)
- Skip authorization cho public endpoints (isPublic)
- Láº¥y user role tá»« header X-User-Role (set bá»Ÿi Authentication Filter)
- Resolve role name â†’ level qua RoleService.getRoleLevel()
- Level check: userLevel >= endpoint.minRoleLevel?
   âœ” Allow â†’ Next Filter
   âœ– Deny â†’ ErrorHandler â†’ 403 FORBIDDEN
```

**ğŸ”‘ Authorization Logic (Level-Based Hierarchy):**
```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    1.  â”‚ Resolve Endpoint                                        â”‚
        â”‚ â€¢ Match request path + method â†’ EndpointsEntity         â”‚
        â”‚ â€¢ Using EndpointRegisterService.getEndpoint()           â”‚
        â”‚ â€¢ Extract endpoint.minRoleLevel                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    2.  â”‚ Check: Is Public Endpoint?                              â”‚
        â”‚ â€¢ endpoint.isPublic() == true â†’ Skip Authorization      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ No (Protected)                  â”‚ Yes (Public)
                   â”‚                                 â””â”€â”€â†’ Next Filter
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    3.  â”‚ Get User Role from Headers                              â”‚
        â”‚ â€¢ X-User-Role: "ADMIN" (set by Authentication Filter)   â”‚
        â”‚ âœ– Missing or empty?                                     â”‚
        â”‚   â†’ ErrorHandler.writeError(exchange,                   â”‚
        â”‚       "Missing X-User-Role header", 403 FORBIDDEN)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    4.  â”‚ Resolve User Level                                      â”‚
        â”‚ â€¢ RoleService.getRoleLevel("ADMIN") â†’ 4                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    5.  â”‚ Level Check                                             â”‚
        â”‚ â€¢ userLevel >= endpoint.minRoleLevel â†’ Allow            â”‚
        â”‚ â€¢ userLevel <  endpoint.minRoleLevel â†’ Deny             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚
       Allow Access    Deny Access
           â”‚               â”‚
       Next Filter     403 Forbidden Error
```

**ğŸ‘¥ Role Hierarchy (Level-Based):**
```
    Level 4: ADMIN    â†’ Full access to all endpoints
    Level 3: MANAGER  â†’ Management endpoints + lower
    Level 2: STAFF    â†’ Staff-level endpoints + lower
    Level 1: USER     â†’ User-specific endpoints only

    Rule: userRole.level >= endpoint.min_role_level â†’ Allow
    Higher level = more permissions (inherits all lower levels)
```
---

### Filter 4: Rate Limiting Filter (Dual Implementation)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
ğŸ”² Kiá»ƒm tra sá»‘ lÆ°á»£ng token cÃ²n láº¡i (remaining quota)
ğŸ”² Cho phÃ©p request tiáº¿p tá»¥c náº¿u cÃ²n token available
ğŸ”² Tá»« chá»‘i request náº¿u vÆ°á»£t quÃ¡ giá»›i háº¡n â†’ 429 Too Many Requests
ğŸ”² Há»— trá»£ rate limiting theo IP (public endpoints)
ğŸ”² Há»— trá»£ rate limiting theo Account ID (protected endpoints)
```

**ğŸ“Š Chiáº¿n LÆ°á»£c Rate Limiting:**

|  | **Strategy 1: IP-Based** | **Strategy 2: Account-Based** |
|---|---|---|
| **Order** | -10 | 10 |
| **Vá»‹ trÃ­** | TrÆ°á»›c Authentication Filter | Sau Authentication Filter |
| **Má»¥c tiÃªu** | All Public endpoints | Protected endpoints |
| **Má»¥c Ä‘Ã­ch** | Chá»‘ng DDoS | Giá»›i háº¡n usage per user/account (quota management) |
| **Cache Key** | `rate_limit:ip:{IP_ADDRESS}` | `rate_limit:account:{ACCOUNT_ID}` |

**Use Cases:**
- API usage quotas per subscription tier
- Prevent single user from overloading system
- Fair resource distribution among users

---

### ğŸª£ Thuáº­t ToÃ¡n: Token Bucket vá»›i Redis

**Token Bucket lÃ  gÃ¬?**

Token Bucket lÃ  thuáº­t toÃ¡n rate limiting hoáº¡t Ä‘á»™ng theo nguyÃªn lÃ½ "xÃ´ chá»©a token".
Má»—i request muá»‘n Ä‘i qua pháº£i "tráº£" 1 token. Náº¿u xÃ´ háº¿t token â†’ request bá»‹ tá»« chá»‘i.

**3 tham sá»‘ cá»‘t lÃµi:**

- **Burst Capacity** (dung lÆ°á»£ng xÃ´): Sá»‘ token tá»‘i Ä‘a mÃ  xÃ´ cÃ³ thá»ƒ chá»©a.

- **Replenish Rate** (tá»‘c Ä‘á»™ náº¡p): Sá»‘ token Ä‘Æ°á»£c náº¡p láº¡i má»—i giÃ¢y.

- **Token Cost** (giÃ¡ má»—i request): Má»—i request tiÃªu thá»¥ bao nhiÃªu token.

---

### âš™ï¸ CÃ¡ch Hoáº¡t Äá»™ng Chi Tiáº¿t

**Thiáº¿t káº¿: TÃ¡ch thÃ nh 2 thÃ nh pháº§n Ä‘á»™c láº­p**

Thay vÃ¬ má»—i request tá»± tÃ­nh refill (lazy refill), tÃ¡ch thÃ nh:
- **Refill Worker** (background) -- cháº¡y má»—i phÃºt, chá»‰ lo náº¡p token
- **Request Handler** (filter) -- chá»‰ lo check & trá»« token, khÃ´ng tÃ­nh thá»i gian

Æ¯u Ä‘iá»ƒm:
- Request handler Ä‘Æ¡n giáº£n hÆ¡n: chá»‰ 1 lá»‡nh DECR trÃªn Redis, khÃ´ng cáº§n tÃ­nh toÃ¡n
- Refill logic táº­p trung 1 chá»—, dá»… thay Ä‘á»•i rate mÃ  khÃ´ng áº£nh hÆ°á»Ÿng filter
- Giáº£m race condition: khÃ´ng cÃ³ 2 request cÃ¹ng tÃ­nh refill Ä‘á»“ng thá»i

#### **1. Refill Worker (Scheduled Background Job)**

Worker cháº¡y báº±ng `@Scheduled`, má»—i phÃºt quÃ©t táº¥t cáº£ bucket keys trÃªn Redis
vÃ  náº¡p token theo replenish rate.

```
// Cháº¡y má»—i 60 giÃ¢y
@Scheduled(fixedRate = 60000)
FUNCTION refillAllBuckets()
    // Láº¥y táº¥t cáº£ bucket keys tá»« Redis
    keys â† REDIS.KEYS("rate_limit:*")

    FOR EACH key IN keys
        bucket â† REDIS.GET(key)
        IF bucket = NULL THEN CONTINUE

        // Náº¡p token: rate * 60 giÃ¢y = tokens Ä‘Æ°á»£c thÃªm má»—i phÃºt
        tokensToAdd â† bucket.rate Ã— 60
        newTokens â† MIN(bucket.tokens + tokensToAdd, bucket.capacity)

        // Atomic update trÃªn Redis
        REDIS.SET(key, { ...bucket, tokens: newTokens })
    END FOR
END FUNCTION
```

#### **2. Request Handler (Filter Logic)**

Filter chá»‰ cáº§n check token vÃ  trá»«. KhÃ´ng tÃ­nh refill.

```
FUNCTION handleRequest(key, burstCapacity)

    Step 1: Láº¥y bucket tá»« Redis
        bucket â† REDIS.GET(key)

        IF bucket = NULL THEN
            // Láº§n Ä‘áº§u gáº·p key â†’ táº¡o bucket má»›i vá»›i capacity Ä‘áº§y
            bucket â† { tokens: burstCapacity, capacity: burstCapacity, rate: replenishRate }
            REDIS.SET(key, bucket, TTL)

    Step 2: Check & Decrement (atomic)
        IF bucket.tokens â‰¥ 1 THEN
            REDIS.DECR(key.tokens)          // Atomic -1
            RETURN ALLOW  âœ… â†’ Next Filter
        ELSE
            RETURN REJECT âŒ â†’ 429 Too Many Requests

END FUNCTION
```

> **Atomic operation:** DÃ¹ng `DECR` hoáº·c Lua script trÃªn Redis Ä‘á»ƒ Ä‘áº£m báº£o
> 2 request Ä‘á»“ng thá»i khÃ´ng trá»« cÃ¹ng 1 token.

#### **3. Redis Cache Strategy**

**IP-Based Cache (Public Endpoints):**
```
    Key Pattern:  rate_limit:ip:{IP_ADDRESS}
    Value:        { "tokens": 95, "capacity": 100, "rate": 10 }
    TTL:          3600 seconds (1 hour, auto-cleanup inactive keys)

    Example Keys:
    - rate_limit:ip:192.168.1.100
    - rate_limit:ip:203.0.113.45
```

**Account-Based Cache (Protected Endpoints):**
```
    Key Pattern:  rate_limit:id:{ACCOUNT_ID}
    Value:        { "tokens": 850, "capacity": 1000, "rate": 50 }
    TTL:          3600 seconds (1 hour)

    Example Keys:
    - rate_limit:id:8c9d0e1f-2a3b-4c5d-6e7f-8a9b0c1d2e3f
    - rate_limit:id:6a7b8c9d-0e1f-2a3b-4c5d-6e7f8a9b0c1d
```

> **TTL Ä‘Ã³ng vai trÃ² cleanup:** Náº¿u 1 IP/account khÃ´ng gá»­i request trong 1 giá»,
> Redis tá»± xoÃ¡ key. Láº§n request tiáº¿p theo sáº½ táº¡o bucket má»›i vá»›i capacity Ä‘áº§y.

---

## PHASE 3: MONITORING & OBSERVABILITY

### ğŸ“Š 1. Metrics (Micrometer + Prometheus)

**Äá»‹nh NghÄ©a:**
```
Metrics lÃ  cÃ¡c thÃ´ng sá»‘ Ä‘o lÆ°á»ng hiá»‡u suáº¥t há»‡ thá»‘ng Ä‘Æ°á»£c thu tháº­p liÃªn tá»¥c
vÃ  hiá»ƒn thá»‹ dÆ°á»›i dáº¡ng biá»ƒu Ä‘á»“ (time-series data) Ä‘á»ƒ phÃ¢n tÃ­ch xu hÆ°á»›ng.
```

**ğŸ› ï¸ TechStack:**

| **Component** | **Technology** | **Vai trÃ²** | **Port** |
|---------------|----------------|-------------|----------|
| **Exposer** | Spring Boot Actuator + Micrometer | Expose metrics endpoints tá»« á»©ng dá»¥ng Spring Boot | `/actuator/prometheus` |
| **Collector** | Prometheus | Thu tháº­p (scrape) metrics tá»« cÃ¡c service theo interval | Default: 9090 |
| **Visualization** | Grafana | Táº¡o dashboard, biá»ƒu Ä‘á»“ trá»±c quan tá»« dá»¯ liá»‡u Prometheus | Default: 3000 |

**ğŸ“Š Luá»“ng Hoáº¡t Äá»™ng:**

```
    Spring Boot App (Micrometer) 
        â†“ expose metrics
    `/actuator/prometheus` endpoint
        â†“ scrape every 15s
    Prometheus Server (Time-series DB)
        â†“ query data
    Grafana Dashboard (Visualization)
        â†“ display
    Beautiful Charts & Alerts
```

#### **CÃ¡c Loáº¡i Metrics:**

##### **Counter (Bá»™ Äáº¿m TÄƒng Dáº§n)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ Chá»‰ tÄƒng, khÃ´ng giáº£m
    â€¢ Reset vá» 0 khi restart service
    â€¢ DÃ¹ng Ä‘á»ƒ Ä‘áº¿m sá»‘ lÆ°á»£ng events (requests)

    Use Cases:
    âœ… Total requests count
    âœ… Total errors count
    âœ… Total successful authentication
```

##### **Gauge (GiÃ¡ Trá»‹ Táº¡i Thá»i Äiá»ƒm)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ CÃ³ thá»ƒ tÄƒng hoáº·c giáº£m
    â€¢ Äo giÃ¡ trá»‹ hiá»‡n táº¡i táº¡i thá»i Ä‘iá»ƒm query
    â€¢ Snapshot cá»§a resource

    Use Cases:
    âœ… Current CPU usage (%)
    âœ… Current memory usage (MB)
    âœ… Active connections count
    âœ… Current thread pool size
    âœ… Redis connection pool availability
```

##### **Histogram (PhÃ¢n Bá»‘ Dá»¯ Liá»‡u)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ Äo phÃ¢n bá»‘ giÃ¡ trá»‹ trong nhiá»u buckets
    â€¢ TÃ­nh percentiles
    â€¢ Hiá»ƒu Ä‘Æ°á»£c distribution pattern

    Use Cases:
    âœ… Request duration distribution
    âœ… Response size distribution
    âœ… Token bucket refill latency
```

---

### ğŸ“ 2. Logging (Structured Logging with Logback)

**Äá»‹nh NghÄ©a:**
```
    Logging lÃ  viá»‡c ghi láº¡i chi tiáº¿t events vÃ  errors trong application
    dÆ°á»›i dáº¡ng text/JSON Ä‘á»ƒ debug, audit vÃ  troubleshooting.
```

---

### ğŸ“‹ Logging Strategy

#### **1. Access Logs (Request/Response Logs)**
```
    Má»¥c Ä‘Ã­ch: Theo dÃµi truy cáº­p CÃI GÃŒ vÃ  KHI NÃ€O
    Cáº¥u trÃºc: Cáº¥u trÃºc JSON/text dá»… Ä‘á»c
```

**Access Log Fields:**
```json
{
  "timestamp": "2026-02-02T10:30:45.123Z",
  "traceId": "abc123def456",
  "clientIp": "192.168.1.100",
  "method": "GET",
  "path": "/api/users/123",
  "queryParams": "?page=1&limit=10",
  "requestHeaders": {
    "User-Agent": "Mozilla/5.0...",
    "Authorization": "Bearer ***"
  },
  "statusCode": 200,
  "responseTime": 145,
  "responseSize": 2048,
  "userId": "user_12345",
  "endpoint": "user-service",
  "filterChain": ["validation", "auth", "authz"],
  "rateLimitStatus": "allowed"
}
```

---

#### **2. Application Logs (Business Logic & Errors)**
```
    Má»¥c Ä‘Ã­ch: theo dÃµi hÃ nh Ä‘á»™ng, lá»—i, thÃ´ng tin debug cá»§a application
    Cáº¥u trÃºc: Cáº¥u trÃºc theo context
```

---

### ğŸ” 3. Distributed Tracing (Spring Cloud Sleuth + Zipkin)

**Äá»‹nh NghÄ©a:**
```
    Tracing lÃ  viá»‡c theo dÃµi má»™t request Ä‘i qua nhiá»u services (microservices) 
    Ä‘á»ƒ hiá»ƒu Ä‘Æ°á»£c flow, identify bottlenecks vÃ  debug distributed systems.
```

#### **Key Concepts:**

##### **Trace**
```
    Represents toÃ n bá»™ journey cá»§a 1 request qua nhiá»u services
    Má»—i trace cÃ³ unique Trace ID
```

##### **Span**
```
    Represents 1 Ä‘oáº¡n cÃ´ng viá»‡c trong trace (1 operation)
    Má»—i span cÃ³ unique Span ID vÃ  thuá»™c vá» 1 Trace ID
```

**Example Trace Flow:**
```
Client Request
    â”‚
    â”œâ”€ Trace ID: abc-123-def
    â”‚
    â”œâ”€ Span 1: API Gateway (Validation Filter)
    â”‚  â””â”€ Duration: 5ms
    â”‚
    â”œâ”€ Span 2: API Gateway (Authentication Filter)
    â”‚  â””â”€ Duration: 20ms (JWT validation)
    â”‚
    â”œâ”€ Span 3: API Gateway (Authorization Filter)
    â”‚  â””â”€ Duration: 3ms
    â”‚
    â”œâ”€ Span 4: API Gateway â†’ User Service
    â”‚  â””â”€ Duration: 150ms
    â”‚     â”‚
    â”‚     â”œâ”€ Span 4.1: User Service (Business Logic)
    â”‚     â”‚  â””â”€ Duration: 50ms
    â”‚     â”‚
    â”‚     â””â”€ Span 4.2: User Service â†’ Database Query
    â”‚        â””â”€ Duration: 100ms
    â”‚
    â””â”€ Total Duration: 178ms
```

---

## PHASE 4: LOAD BALANCING & RESILIENCE

### ğŸ¯ Má»¥c Ä‘Ã­ch

| **Äáº·c tÃ­nh** | **MÃ´ táº£** |
|--------------|-----------|
| **High Availability** | Náº¿u má»™t instance bá»‹ sáº­p (crash), há»‡ thá»‘ng váº«n hoáº¡t Ä‘á»™ng nhá» cÃ¡c instance cÃ²n láº¡i |
| **Scalability** | Khi lÆ°á»£ng user tÄƒng vá»t, báº¡n báº­t thÃªm instance má»›i Ä‘á»ƒ chá»‹u táº£i |

---

### âš™ï¸ CÃ¡c Thuáº­t ToÃ¡n Phá»• Biáº¿n

| **Thuáº­t toÃ¡n** | **CÆ¡ cháº¿** | **Æ¯u Ä‘iá»ƒm** | **NhÆ°á»£c Ä‘iá»ƒm / PhÃ¹ há»£p** |
|----------------|------------|-------------|--------------------------|
| **Round Robin**<br>(VÃ²ng trÃ²n) | Gateway phÃ¢n phá»‘i láº§n lÆ°á»£t theo thá»© tá»±:<br>Request 1 â†’ Instance A<br>Request 2 â†’ Instance B<br>Request 3 â†’ Instance C<br>Request 4 â†’ quay láº¡i Instance A | âœ… ÄÆ¡n giáº£n, dá»… cÃ i Ä‘áº·t | âŒ KhÃ´ng quan tÃ¢m Ä‘áº¿n tÃ¬nh tráº¡ng sá»©c khá»e cá»§a server<br>(Instance A Ä‘ang cháº­m váº«n bá»‹ dÃ­ request) |
| **Weighted Round Robin**<br>(VÃ²ng trÃ²n cÃ³ trá»ng sá»‘) | TÆ°Æ¡ng tá»± Round Robin, nhÆ°ng gÃ¡n "Ä‘iá»ƒm sá»‘" cho server.<br>Server máº¡nh hÆ¡n (RAM/CPU cao) nháº­n trá»ng sá»‘ cao hÆ¡n | âœ… Tá»‘i Æ°u cho háº¡ táº§ng khÃ´ng Ä‘á»“ng nháº¥t | ğŸ¯ PhÃ¹ há»£p: Khi cÃ³ mÃ¡y máº¡nh, mÃ¡y yáº¿u |
| **Least Connections**<br>(Ãt káº¿t ná»‘i nháº¥t) | Gateway kiá»ƒm tra instance nÃ o Ä‘ang xá»­ lÃ½ Ã­t request nháº¥t vÃ  Ä‘áº©y request má»›i vÃ o Ä‘Ã³ | âœ… Tá»‘i Æ°u cho request cÃ³ thá»i gian xá»­ lÃ½ khÃ´ng Ä‘á»u<br>âœ… TrÃ¡nh server bá»‹ quÃ¡ táº£i | ğŸ¯ PhÃ¹ há»£p: Request cÃ³ Ä‘á»™ phá»©c táº¡p khÃ¡c nhau |

---

### ğŸ” Káº¿t Há»£p Vá»›i Service Discovery

```
Backend Service Start â†’ Register IP/Port â†’ Service Registry
                                              â†“
API Gateway Receives Request â†’ Query Registry â†’ Get Active Instances
                                              â†“
                                    Apply Load Balancing Algorithm
                                              â†“
                                    Forward Request to Selected Instance
```

| **BÆ°á»›c** | **MÃ´ táº£** |
|----------|-----------|
| **1. Service Discovery** | Khi Backend khá»Ÿi Ä‘á»™ng, Ä‘Äƒng kÃ½ IP/Port lÃªn Service Registry (danh báº¡ chung) |
| **2. API Gateway Query** | Khi nháº­n request, Gateway há»i "danh báº¡" xem Service A cÃ³ nhá»¯ng instance nÃ o active |
| **3. Load Balancing** | Sau khi cÃ³ danh sÃ¡ch IP, Gateway dÃ¹ng thuáº­t toÃ¡n (VD: Round Robin) Ä‘á»ƒ chá»n IP vÃ  chuyá»ƒn tiáº¿p |

> ğŸ’¡ **LÆ°u Ã½:** Trong Spring Cloud, Spring Cloud Gateway káº¿t há»£p vá»›i **Spring Cloud LoadBalancer** Ä‘á»ƒ thá»±c hiá»‡n tá»± Ä‘á»™ng.

---
x